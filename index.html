<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON | Lightcycle Run</title>
    
    <!-- Fonts: Inter for data, Orbitron for headers -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        grid: {
                            950: '#020617', // Deepest background
                            900: '#0f172a', // Panel background
                            800: '#1e293b', // Border/Hover
                        },
                        neon: {
                            cyan: '#00f3ff',
                            blue: '#0099ff',
                            orange: '#ff9e00',
                            white: '#e2e8f0'
                        }
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #1e293b 1px, transparent 1px), linear-gradient(to bottom, #1e293b 1px, transparent 1px)",
                    },
                    boxShadow: {
                        'glow-cyan': '0 0 10px rgba(0, 243, 255, 0.3), 0 0 20px rgba(0, 243, 255, 0.1)',
                        'glow-orange': '0 0 10px rgba(255, 158, 0, 0.3), 0 0 20px rgba(255, 158, 0, 0.1)',
                    },
                    animation: {
                        'scanline': 'scanline 4s linear infinite',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'spin-slow': 'spin 10s linear infinite',
                    },
                    keyframes: {
                        scanline: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '0.8', filter: 'brightness(1)' },
                            '50%': { opacity: '1', filter: 'brightness(1.2)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* TRON-inspired CSS Filters */
        .style-neon {
            filter: contrast(1.2) brightness(1.1) hue-rotate(180deg) saturate(1.8);
        }
        .style-wireframe {
            filter: grayscale(1) contrast(4) brightness(1.3) invert(1);
        }
        .style-legacy {
            filter: sepia(0.8) hue-rotate(160deg) saturate(2.5) contrast(1.1); /* Amber/Orange tint */
        }
        .style-glitch {
            filter: contrast(2) saturate(0) brightness(0.8);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #0f172a;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 2px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #00f3ff;
        }

        /* CRT Overlay Effect */
        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
        }

        .frame-container {
            aspect-ratio: 4/5;
        }

        .clip-tech {
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }
    </style>
</head>
<body class="bg-grid-950 text-neon-white flex flex-col min-h-screen lg:h-screen lg:overflow-hidden selection:bg-neon-cyan selection:text-black font-sans relative">

    <!-- Grid Background -->
    <div class="absolute inset-0 bg-grid-pattern bg-[length:40px_40px] opacity-10 pointer-events-none z-0"></div>

    <!-- Header -->
    <header class="h-16 border-b border-white/10 flex items-center justify-between px-6 shrink-0 z-20 bg-grid-950/90 backdrop-blur-md">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 rounded-full border-2 border-neon-cyan shadow-glow-cyan flex items-center justify-center animate-pulse-glow">
                <div class="w-2 h-2 bg-neon-cyan rounded-full"></div>
            </div>
            <h1 class="font-display font-bold text-lg tracking-[0.2em] text-white uppercase leading-none">TRON <span class="text-neon-cyan">Lightcycle Run</span></h1>
        </div>
        <div class="flex items-center gap-4 text-[10px] font-mono text-neon-cyan/50 uppercase tracking-tighter">
            <span>Core v4.0.1</span>
            <div class="w-2 h-2 bg-neon-cyan rounded-full animate-pulse"></div>
            <span>System: Optimal</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row lg:overflow-hidden relative z-10">
        
        <!-- UI AREA 1: Input (Left) -->
        <section class="w-full lg:w-[20%] border-r border-white/10 flex flex-col bg-grid-900/40 backdrop-blur-sm">
            <div class="p-5 border-b border-white/5">
                <h2 class="font-display text-[10px] font-bold uppercase tracking-widest text-neon-cyan mb-1">01. Data Input</h2>
                <p class="text-[11px] text-slate-500 font-mono">Upload user biometric source.</p>
            </div>
            
            <div class="p-5 lg:flex-1 lg:overflow-y-auto custom-scroll">
                <div id="drop-zone" class="relative group cursor-pointer h-full max-h-[280px]">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" accept="image/*">
                    
                    <div id="upload-ui" class="border border-dashed border-white/20 bg-white/5 h-48 lg:h-64 flex flex-col items-center justify-center text-center transition-all duration-300 group-hover:border-neon-cyan group-hover:bg-neon-cyan/5 group-hover:shadow-glow-cyan">
                        <i class="ph-duotone ph-scan text-3xl text-slate-500 group-hover:text-neon-cyan mb-3"></i>
                        <h3 class="font-display text-xs font-bold text-white tracking-widest uppercase">Initiate Digitization</h3>
                        <p class="text-[9px] font-mono text-neon-cyan/50 mt-2">DRAG IMAGE // JPG-PNG</p>
                    </div>

                    <div id="source-preview-container" class="hidden relative h-48 lg:h-64 border border-neon-cyan/30 bg-black group overflow-hidden">
                        <div class="absolute inset-0 z-10 bg-gradient-to-b from-transparent via-neon-cyan/20 to-transparent h-[10%] w-full animate-scanline opacity-40"></div>
                        <img id="source-image" class="w-full h-full object-cover opacity-70" src="" alt="Original">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-20">
                            <button id="remove-btn" class="border border-neon-cyan text-neon-cyan px-4 py-2 text-[10px] font-display tracking-widest hover:bg-neon-cyan hover:text-black transition-all">
                                RE-INITIALIZE
                            </button>
                        </div>
                    </div>
                </div>

                <div id="file-info" class="mt-4 hidden animate-slide-up border-l-2 border-neon-cyan pl-3">
                    <p class="text-[9px] text-slate-500 font-mono uppercase tracking-widest">Buffer Status:</p>
                    <p id="filename" class="text-xs font-mono text-white truncate">identity_cache_01.img</p>
                </div>
            </div>
        </section>

        <!-- UI AREA 2: Protocols (Styles) -->
        <section class="w-full lg:w-[20%] border-r border-white/10 flex flex-col bg-grid-900/20 backdrop-blur-sm">
            <div class="p-5 border-b border-white/5">
                <h2 class="font-display text-[10px] font-bold uppercase tracking-widest text-neon-orange mb-1">02. Select Protocol</h2>
                <p class="text-[11px] text-slate-500 font-mono">Choose visual identity vector.</p>
            </div>

            <div class="p-5 lg:flex-1 lg:overflow-y-auto custom-scroll space-y-3">
                
                <button onclick="selectStyle('neon')" id="btn-neon" class="style-card w-full text-left p-4 border border-white/10 bg-white/5 hover:border-neon-cyan hover:bg-neon-cyan/5 hover:shadow-glow-cyan transition-all duration-300 group relative overflow-hidden disabled:opacity-30">
                    <div class="relative flex items-center gap-4 z-10">
                        <div class="w-8 h-8 flex items-center justify-center border border-neon-cyan/30 bg-black/50 text-neon-cyan">
                            <i class="ph-duotone ph-lightning"></i>
                        </div>
                        <div>
                            <h4 class="font-display text-[11px] font-bold text-white tracking-widest uppercase">The Grid</h4>
                            <p class="text-[9px] text-slate-500 font-mono mt-0.5">Neon saturation v1.</p>
                        </div>
                    </div>
                    <div class="selection-ring absolute right-0 top-0 bottom-0 w-1 bg-neon-cyan opacity-0 transition-opacity shadow-glow-cyan"></div>
                </button>

                <button onclick="selectStyle('wireframe')" id="btn-wireframe" class="style-card w-full text-left p-4 border border-white/10 bg-white/5 hover:border-white hover:bg-white/5 transition-all duration-300 group relative overflow-hidden disabled:opacity-30">
                    <div class="relative flex items-center gap-4 z-10">
                        <div class="w-8 h-8 flex items-center justify-center border border-white/30 bg-black/50 text-white">
                            <i class="ph-duotone ph-grid-four"></i>
                        </div>
                        <div>
                            <h4 class="font-display text-[11px] font-bold text-white tracking-widest uppercase">Wireframe</h4>
                            <p class="text-[9px] text-slate-500 font-mono mt-0.5">Structural analysis.</p>
                        </div>
                    </div>
                    <div class="selection-ring absolute right-0 top-0 bottom-0 w-1 bg-white opacity-0 transition-opacity"></div>
                </button>

                <button onclick="selectStyle('legacy')" id="btn-legacy" class="style-card w-full text-left p-4 border border-white/10 bg-white/5 hover:border-neon-orange hover:bg-neon-orange/5 hover:shadow-glow-orange transition-all duration-300 group relative overflow-hidden disabled:opacity-30">
                    <div class="relative flex items-center gap-4 z-10">
                        <div class="w-8 h-8 flex items-center justify-center border border-neon-orange/30 bg-black/50 text-neon-orange">
                            <i class="ph-duotone ph-clock-counter-clockwise"></i>
                        </div>
                        <div>
                            <h4 class="font-display text-[11px] font-bold text-white tracking-widest uppercase">Legacy</h4>
                            <p class="text-[9px] text-slate-500 font-mono mt-0.5">Retro Flynn protocol.</p>
                        </div>
                    </div>
                    <div class="selection-ring absolute right-0 top-0 bottom-0 w-1 bg-neon-orange opacity-0 transition-opacity shadow-glow-orange"></div>
                </button>

                <button onclick="selectStyle('glitch')" id="btn-glitch" class="style-card w-full text-left p-4 border border-white/10 bg-white/5 hover:border-red-500 hover:bg-red-500/5 hover:shadow-[0_0_10px_rgba(239,68,68,0.3)] transition-all duration-300 group relative overflow-hidden disabled:opacity-30">
                    <div class="relative flex items-center gap-4 z-10">
                        <div class="w-8 h-8 flex items-center justify-center border border-red-500/30 bg-black/50 text-red-500">
                            <i class="ph-duotone ph-warning-octagon"></i>
                        </div>
                        <div>
                            <h4 class="font-display text-[11px] font-bold text-white tracking-widest uppercase">Derezz</h4>
                            <p class="text-[9px] text-slate-500 font-mono mt-0.5">Identity corruption.</p>
                        </div>
                    </div>
                    <div class="selection-ring absolute right-0 top-0 bottom-0 w-1 bg-red-500 opacity-0 transition-opacity"></div>
                </button>

            </div>
        </section>

        <!-- UI AREA 3: Magic Canvas -->
        <section class="flex-1 bg-black/50 p-6 flex flex-col relative overflow-hidden min-h-[600px] lg:min-h-0">
            <div class="absolute top-0 left-0 w-full h-0.5 bg-neon-cyan shadow-glow-cyan opacity-0 transition-opacity" id="loading-bar"></div>

            <div class="flex items-center justify-between mb-4">
                 <div>
                    <h2 class="font-display text-[10px] font-bold uppercase tracking-widest text-white mb-1">03. Identity Disc</h2>
                    <p class="text-[11px] text-slate-500 font-mono">Program verification stage.</p>
                 </div>
                 <button id="download-btn" disabled class="px-4 py-2 border border-neon-cyan text-neon-cyan text-[10px] font-display tracking-widest uppercase hover:bg-neon-cyan hover:text-black hover:shadow-glow-cyan transition-all disabled:opacity-30 disabled:shadow-none">
                    Export Identity
                 </button>
            </div>

            <div class="flex-1 bg-grid-pattern bg-[length:20px_20px] relative flex items-center justify-center overflow-hidden border border-white/5">
                
                <div id="result-container" class="relative w-full max-w-sm frame-container shadow-[0_0_50px_rgba(0,0,0,1)] transition-all duration-700 transform scale-100 opacity-100">
                    
                    <!-- Base Placeholder -->
                    <div id="canvas-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-grid-950/80 p-6 text-center z-10 border border-white/5">
                        <div class="w-16 h-16 rounded-full border border-dashed border-white/10 flex items-center justify-center mb-4 text-white/20 animate-spin-slow">
                            <i class="ph ph-aperture text-3xl"></i>
                        </div>
                        <h3 class="font-display text-xs font-bold text-white tracking-widest uppercase">No User Loaded</h3>
                        <p class="text-[10px] font-mono text-neon-cyan/40 mt-1 uppercase">Awaiting biometric data stream.</p>
                    </div>

                    <!-- Processed Image Layer -->
                    <img id="result-image" src="" alt="Result" class="absolute inset-0 w-full h-full object-cover z-20 hidden" style="object-position: center 25%;">
                    
                    <!-- Loader Layer -->
                    <div id="loader" class="absolute inset-0 bg-grid-950/90 backdrop-blur-sm z-30 flex flex-col items-center justify-center hidden">
                        <div class="w-10 h-10 border-2 border-neon-cyan border-t-transparent rounded-full animate-spin shadow-glow-cyan"></div>
                        <p class="text-[10px] font-display tracking-widest text-neon-cyan mt-4 animate-pulse uppercase">Compiling Program...</p>
                    </div>

                    <!-- TRON Identity Disc Frame Layer -->
                    <img id="frame-overlay" src="" alt="Frame" class="absolute inset-0 w-full h-full object-fill z-40 pointer-events-none mix-blend-screen opacity-90">
                    
                    <!-- CRT Overlay Top -->
                    <div class="absolute inset-0 crt-overlay z-50 opacity-40 pointer-events-none"></div>
                </div>
                
                <div id="result-badge" class="absolute bottom-6 bg-grid-950/90 border border-neon-cyan/40 px-4 py-2 text-[9px] font-display tracking-widest uppercase hidden animate-fade-in z-50 text-neon-cyan shadow-glow-cyan">
                    <i class="ph-fill ph-check-circle mr-2"></i> User Identity Verified
                </div>
            </div>
        </section>

        <!-- UI AREA 4: Share -->
        <section class="w-full lg:w-[20%] border-l border-white/10 flex flex-col bg-grid-900/40 backdrop-blur-sm">
            <div class="p-5 border-b border-white/5">
                <h2 class="font-display text-[10px] font-bold uppercase tracking-widest text-white mb-1">04. Transmission</h2>
                <p class="text-[11px] text-slate-500 font-mono">Relay data to outer network.</p>
            </div>

            <div class="p-5 flex flex-col gap-8 lg:flex-1 lg:overflow-y-auto custom-scroll">
                
                <div>
                    <label class="block text-[9px] font-mono text-neon-cyan mb-2 uppercase tracking-widest">>> Protocol: Direct Email</label>
                    <div class="flex">
                        <input type="email" placeholder="USER_ID@GRID.NET" class="w-full px-3 py-2 bg-black/50 border border-white/10 text-[10px] text-white focus:outline-none focus:border-neon-cyan font-mono tracking-widest transition-colors uppercase">
                        <button class="bg-neon-cyan text-black px-3 hover:bg-white transition-colors">
                            <i class="ph-bold ph-paper-plane-right"></i>
                        </button>
                    </div>
                </div>

                <div class="text-center">
                    <label class="block text-[9px] font-mono text-neon-cyan mb-4 uppercase tracking-widest">>> Protocol: Mobile Uplink</label>
                    <div class="bg-white p-2 inline-block shadow-glow-cyan relative group overflow-hidden cursor-pointer">
                        <div class="absolute top-0 left-0 w-full h-0.5 bg-neon-cyan animate-scanline z-10"></div>
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%230f172a'%3E%3Crect x='0' y='0' width='22' height='22'/%3E%3Crect x='78' y='0' width='22' height='22'/%3E%3Crect x='0' y='78' width='22' height='22'/%3E%3Crect x='28' y='0' width='6' height='6'/%3E%3Crect x='42' y='0' width='6' height='6'/%3E%3Crect x='56' y='0' width='6' height='6'/%3E%3Crect x='70' y='0' width='6' height='6'/%3E%3Crect x='35' y='35' width='30' height='30' rx='15' fill='%2300f3ff'/%3E%3C/svg%3E" class="w-28 h-28 opacity-90 group-hover:opacity-100 transition-opacity" alt="Scan QR">
                    </div>
                    <p class="text-[9px] text-slate-500 font-mono mt-3 uppercase tracking-tighter">Scan to access identity on personal device</p>
                </div>

                <div class="mt-auto border border-neon-cyan/10 bg-neon-cyan/5 p-4 text-center clip-tech">
                    <p class="text-[9px] text-neon-cyan font-mono uppercase tracking-[0.3em]">End of Line</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-grid-950 border border-neon-cyan text-neon-cyan px-6 py-3 translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 shadow-glow-cyan">
        <i class="ph-fill ph-check-circle text-white"></i>
        <div class="flex flex-col">
            <span class="text-[10px] font-display tracking-widest uppercase">System Success</span>
            <span class="text-[9px] font-mono text-white/50">Identity exported to buffer.</span>
        </div>
    </div>

    <script>
        // --- APP CONFIGURATION ---
        const CONFIG = {
            useN8n: false, 
            n8nWebhookUrl: 'https://your-n8n-instance.com/webhook/tron-identity',
            
            // TRON Frame: Futuristic Hexagon with Neon Cyan Glow
            frameOverlayUrl: "data:image/svg+xml,%3Csvg width='400' height='500' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='neon' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2300f3ff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230099ff;stop-opacity:1' /%3E%3C/linearGradient%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='3' result='blur'/%3E%3CfeMerge%3E%3CfeMergeNode in='blur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Cpath d='M25,10 L375,10 L390,25 L390,475 L375,490 L25,490 L10,475 L10,25 Z' fill='none' stroke='url(%23neon)' stroke-width='4' filter='url(%23glow)' opacity='0.9'/%3E%3Cpath d='M10,80 L10,25 L65,25 M390,80 L390,25 L335,25 M10,420 L10,475 L65,475 M390,420 L390,475 L335,475' stroke='%2300f3ff' stroke-width='8' fill='none' filter='url(%23glow)' /%3E%3Ccircle cx='200' cy='490' r='25' fill='%23020617' stroke='%2300f3ff' stroke-width='3' filter='url(%23glow)'/%3E%3Ccircle cx='200' cy='490' r='8' fill='%2300f3ff'/%3E%3C/svg%3E"
        };

        const state = {
            imageLoaded: false,
            currentImageSrc: null,
            selectedStyle: null,
            isProcessing: false
        };

        const fileInput = document.getElementById('file-input');
        const uploadUi = document.getElementById('upload-ui');
        const sourcePreviewContainer = document.getElementById('source-preview-container');
        const sourceImage = document.getElementById('source-image');
        const filenameDisplay = document.getElementById('filename');
        const canvasPlaceholder = document.getElementById('canvas-placeholder');
        const resultImage = document.getElementById('result-image');
        const frameOverlay = document.getElementById('frame-overlay');
        const loader = document.getElementById('loader');
        const loadingBar = document.getElementById('loading-bar');
        const resultBadge = document.getElementById('result-badge');
        const downloadBtn = document.getElementById('download-btn');
        const dropZone = document.getElementById('drop-zone');
        const styleButtons = document.querySelectorAll('.style-card');

        resultImage.onload = () => {
            if (state.isProcessing || !resultImage.src) return;
            resultImage.classList.remove('hidden');
            canvasPlaceholder.classList.add('hidden');
            loader.classList.add('hidden');
            loadingBar.classList.add('opacity-0');
            resultBadge.classList.remove('hidden');
            downloadBtn.disabled = false;
        };

        if (CONFIG.frameOverlayUrl) frameOverlay.src = CONFIG.frameOverlayUrl;

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadUi.classList.add('border-neon-cyan', 'bg-neon-cyan/5');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadUi.classList.remove('border-neon-cyan', 'bg-neon-cyan/5');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadUi.classList.remove('border-neon-cyan', 'bg-neon-cyan/5');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        downloadBtn.addEventListener('click', downloadComposite);

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Invalid Data Type', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                state.currentImageSrc = e.target.result;
                state.imageLoaded = true;
                uploadUi.classList.add('hidden');
                sourcePreviewContainer.classList.remove('hidden');
                sourceImage.src = state.currentImageSrc;
                filenameDisplay.textContent = file.name;
                resetCanvas();
            };
            reader.readAsDataURL(file);
        }

        function selectStyle(style) {
            if (!state.imageLoaded || state.isProcessing) {
                if (!state.imageLoaded) showToast('Load user data first', 'error');
                return;
            }
            state.selectedStyle = style;
            updateStyleUI(style);
            processImage(style);
        }

        function updateStyleUI(selectedId) {
            styleButtons.forEach(btn => {
                const ring = btn.querySelector('.selection-ring');
                if (ring) ring.classList.add('opacity-0');
                btn.classList.remove('bg-neon-cyan/10', 'border-neon-cyan');
            });
            const activeBtn = document.getElementById(`btn-${selectedId}`);
            if (activeBtn) {
                const ring = activeBtn.querySelector('.selection-ring');
                if (ring) ring.classList.remove('opacity-0');
                activeBtn.classList.add('bg-neon-cyan/10', 'border-neon-cyan');
            }
        }

        async function processImage(style) {
            state.isProcessing = true;
            loadingBar.classList.remove('opacity-0');
            loader.classList.remove('hidden');
            resultBadge.classList.add('hidden');
            downloadBtn.disabled = true;
            resultImage.classList.add('hidden'); 
            resultImage.className = 'absolute inset-0 w-full h-full object-cover z-20 hidden'; 

            try {
                if (CONFIG.useN8n) {
                    const response = await fetch(CONFIG.n8nWebhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ style, image: state.currentImageSrc })
                    });
                    const data = await response.json();
                    resultImage.src = data.outputUrl;
                } else {
                    await new Promise(r => setTimeout(r, 1800)); // Compiling simulation
                    resultImage.src = state.currentImageSrc;
                    resultImage.classList.add(`style-${style}`);
                    state.isProcessing = false; 
                    resultImage.onload(); 
                    showToast('Protocol applied');
                }
            } catch (error) {
                state.isProcessing = false;
                loader.classList.add('hidden');
                loadingBar.classList.add('opacity-0');
                showToast('Compile Error', 'error');
                canvasPlaceholder.classList.remove('hidden');
            }
        }

        function downloadComposite() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 1000;
            const ctx = canvas.getContext('2d');
            const filterMap = {
                'neon': 'contrast(1.2) brightness(1.1) hue-rotate(180deg) saturate(1.8)',
                'wireframe': 'grayscale(1) contrast(4) brightness(1.3) invert(1)',
                'legacy': 'sepia(0.8) hue-rotate(160deg) saturate(2.5) contrast(1.1)',
                'glitch': 'contrast(2) saturate(0) brightness(0.8)'
            };

            const img = resultImage;
            if (img.naturalWidth) {
                const imgAspect = img.naturalWidth / img.naturalHeight;
                const canvasAspect = canvas.width / canvas.height;
                let rw, rh, ox, oy;
                if (imgAspect > canvasAspect) {
                    rh = canvas.height; rw = canvas.height * imgAspect;
                    ox = (canvas.width - rw) / 2; oy = 0;
                } else {
                    rw = canvas.width; rh = canvas.width / imgAspect;
                    ox = 0; oy = (canvas.height - rh) * 0.25;
                }
                if (!CONFIG.useN8n && filterMap[state.selectedStyle]) ctx.filter = filterMap[state.selectedStyle];
                ctx.drawImage(img, ox, oy, rw, rh);
                ctx.filter = 'none';
            }
            ctx.drawImage(frameOverlay, 0, 0, canvas.width, canvas.height);
            const link = document.createElement('a');
            link.download = `identity_disc_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('Data Exported');
        }

        function resetCanvas() {
            canvasPlaceholder.classList.remove('hidden');
            resultImage.classList.add('hidden');
            resultBadge.classList.add('hidden');
            downloadBtn.disabled = true;
            state.selectedStyle = null;
            updateStyleUI(null);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.querySelector('span:first-child').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
